-- 1. Criar a Tabela Temporária
CREATE TABLE wl_tempdata (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigoPedido VARCHAR(255),
    dataPedido DATE NOT NULL,
    SKU VARCHAR(255),
    UPC VARCHAR(255),
    nomeProduto VARCHAR(255),
    quantidade INT NOT NULL,
    valor DECIMAL(10,2) NOT NULL,
    frete DECIMAL(10,2),
    email VARCHAR(255),
    codigoComprador VARCHAR(255),
    nomeComprador VARCHAR(255),
    endereco VARCHAR(255),
    CEP VARCHAR(10),
    UF CHAR(2),
    pais VARCHAR(50)
);

-- 2. Comando: Inserindo dados do TXT no banco
LOAD DATA INFILE 'C:/Users/casol/Downloads/pedidos.txt'
INTO TABLE wl_tempdata
FIELDS TERMINATED BY ';' 
ENCLOSED BY '"' 
LINES TERMINATED BY '\n'
(codigoPedido, dataPedido, SKU, UPC, nomeProduto, quantidade, valor, frete, email, codigoComprador, nomeComprador, endereco, CEP, UF, pais);

-- 3. Criar a Tabela Clientes
CREATE TABLE wl_clientes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nomeComprador VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    codigoComprador VARCHAR(255) UNIQUE NOT NULL,
    endereco VARCHAR(255) NOT NULL,
    CEP VARCHAR(10) NOT NULL,
    UF CHAR(2) NOT NULL,
    pais VARCHAR(50) NOT NULL
);

-- 4. Criar a Tabela Produtos
CREATE TABLE wl_produtos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    SKU VARCHAR(15) UNIQUE NOT NULL,
    UPC VARCHAR(255),
    nomeProduto VARCHAR(100) NOT NULL,
    valor DECIMAL(10, 2) NOT NULL
);

-- 5. Criar a Tabela Estoque
CREATE TABLE wl_estoque (
    id INT AUTO_INCREMENT PRIMARY KEY,
    SKU VARCHAR(15) UNIQUE NOT NULL,
    quantidade INT NOT NULL
);

-- 6. Criar a Tabela Pedidos
CREATE TABLE wl_pedidos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigoPedido VARCHAR(255) UNIQUE NOT NULL,
    valor DECIMAL(10, 2),
    codigoComprador VARCHAR(255),
    dataPedido DATE NOT NULL,
    status ENUM('pendente', 'entregue', 'cancelado', 'em andamento') NOT NULL
);

-- 7. Criar a Tabela Item do Pedido
CREATE TABLE wl_itemPedido (
    id INT AUTO_INCREMENT PRIMARY KEY,
    codigoPedido VARCHAR(255) NOT NULL,
    SKU VARCHAR(15) NOT NULL,
    quantidade INT NOT NULL,
    valor_unitario DECIMAL(10,2) NOT NULL,
    status ENUM('pendente', 'entregue', 'cancelado') NOT NULL,
    INDEX (codigoPedido),
    INDEX (SKU),
    FOREIGN KEY (codigoPedido) REFERENCES wl_pedidos(codigoPedido),
    FOREIGN KEY (SKU) REFERENCES wl_produtos(SKU)
);

-- 8. Criar a Tabela Entregas
CREATE TABLE wl_entregas (
    id INT AUTO_INCREMENT PRIMARY KEY,
    valor DECIMAL(9,2) NOT NULL,
    codigoPedido VARCHAR(255) NOT NULL,
    endereco VARCHAR(255) NOT NULL,
    CEP VARCHAR(20) NOT NULL,
    UF CHAR(2) NOT NULL,
    pais VARCHAR(50) NOT NULL,
    FOREIGN KEY (codigoPedido) REFERENCES wl_pedidos(codigoPedido)
);

-- 9. Criar a Tabela Compra
CREATE TABLE wl_compra (
    id INT AUTO_INCREMENT PRIMARY KEY,
    SKU VARCHAR(255) NOT NULL,
    quantidade INT NOT NULL,
    valor DECIMAL(10, 2),
    data_compra TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE (SKU)  -- Definindo SKU como chave única
);


-----------------------------------------------------------------------

-- Inserindo os Dados

-- 1. Inserir Dados na Tabela Cliente:
INSERT INTO wl_clientes (nomeComprador, email, codigoComprador, endereco, CEP, UF, pais)
SELECT DISTINCT nomeComprador, email, codigoComprador, endereco, CEP, UF, pais
FROM wl_tempdata
GROUP BY codigoComprador;

-- 2. Inserir Dados na Tabela Produtos:

-- Comando: SQL pra importação dos dados em arquivo CSV:
LOAD DATA INFILE 'C:/Users/casol/Downloads/produtos.csv'
INTO TABLE wl_produtos 
FIELDS TERMINATED BY ',' 
OPTIONALLY ENCLOSED BY '"' 
LINES TERMINATED BY '\n' 
(SKU, UPC, nomeProduto, valor);

-- Ou inserir diretamente da tabela wl_tempdata
INSERT INTO wl_produtos (SKU, UPC, nomeProduto, valor)
SELECT DISTINCT SKU, UPC, nomeProduto, valor
FROM wl_tempdata;

-- 3. Inserir Dados na Tabela Estoque:
INSERT INTO wl_estoque (SKU, quantidade)
SELECT SKU, SUM(quantidade) AS quantidade
FROM wl_tempdata
GROUP BY SKU;

-- 4. Inserir Dados na Tabela Pedidos:
INSERT INTO wl_pedidos (codigoPedido, dataPedido, status)
SELECT DISTINCT codigoPedido, dataPedido, 'pendente' AS status
FROM wl_tempdata
JOIN wl_clientes ON wl_tempdata.codigoComprador = wl_clientes.codigoComprador;

-- 5. Inserir Dados na Tabela ItemPedido:
INSERT INTO wl_itemPedido (codigoPedido, SKU, quantidade, valor_unitario, status)
SELECT wl_tempdata.codigoPedido, wl_tempdata.SKU, wl_tempdata.quantidade, wl_tempdata.valor, 'pendente' AS status
FROM wl_tempdata
JOIN wl_pedidos ON wl_tempdata.codigoPedido = wl_pedidos.codigoPedido
JOIN wl_produtos ON wl_tempdata.SKU = wl_produtos.SKU;

-- Inserir Dados na Tabela Compra
INSERT INTO wl_compra (SKU, quantidade)
SELECT SKU, SUM(quantidade) AS quantidade
FROM wl_tempdata
GROUP BY SKU;

-- Inserir Dados na Tabela Entregas
INSERT INTO wl_entregas (valor, codigoPedido, endereco, CEP, UF, pais)
SELECT frete, codigoPedido, endereco, CEP, UF, pais
FROM wl_tempdata;


DROP TEMPORARY TABLE wl_tempdata;

-- FIM DA ATIVIDADE 1 

-----------------------------------------------------------------------
